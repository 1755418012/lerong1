<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="./assets/jquery.js"></script>
    <script src="./js/main.js"></script>
    <script src="./assets/jquery.banner.1.3.js"></script>
    <script src="./assets/ajax.js"></script>
    <script src="./assets/jquery.cookie.js"></script>
    <script src="./assets/cookie.js"></script>
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./assets/fonts/style.css">
</head>

<body style="background: #fff;">
    <!-- æ·»åŠ å…¬å…±æ ·å¼å¤´éƒ¨ -->
    <div class="sorttop"></div>

    <div class="line"></div>
    <div class="main">
        <div class="container">
            <div class="main-m">
                <div class="main-l">
                    <div class="main-lt">
                        <!-- <img src="" alt=""> -->
                    </div>
                    <div class="main-lb">
                        <span class="ll">ğŸ‘ˆ</span>
                        <ul class="dots">
                            <!-- <li></li> -->
                        </ul>
                        <span class="rr">ğŸ‘‰</span>
                    </div>
                </div>
                <div class="main-r">
                    <div class="main-rr">
                        <!-- <p class="main-name"></p>
                        <p class="main-tip"></p>
                        <p class="main-price"></p>
                        <div class="addcart"></div> -->
                    </div>
                </div>
            </div>
            <div class="main-list">
                <ul>
                    <li>å•†å“ä»‹ç»</li>
                    <li>å‚æ•°è§„æ ¼</li>
                    <li>è¯„ä»·æ™’å•</li>
                    <li>å”®åæœåŠ¡</li>
                    <li>å¸®åŠ©ä¸­å¿ƒ</li>
                </ul>
            </div>
            <div class="main-tu">
                <!-- <p><img src="" alt=""></p> -->
            </div>
        </div>
    </div>
    <div class="tan">
        <p>æ·»åŠ æˆåŠŸ âœ” </p>
        <div>
            <span style="background: #d80c18;color: #fff;" class="tan1">ç»§ç»­è´­ç‰©</span>
            <span class="tan2">å»ç»“ç®—</span>
        </div>
    </div>

    <!-- æ·»åŠ å…¬å…±æ ·å¼çš„åº•éƒ¨ -->
    <div class="sortfooter"></div>
</body>
<script>
    $('.sorttop').load("./top.html");       //å¼•å…¥å…¬å…±æ ·å¼çš„å¤´æ–‡ä»¶
    $(".sortfooter").load("./footer.html"); //å¼•å…¥å…¬å…±æ ·å¼çš„å°¾éƒ¨æ–‡ä»¶

    class Details {
        constructor() {
            this.url = "data/all.json";
            this.mlt = document.querySelector(".main-lt");
            this.dots = document.querySelector(".dots");
            this.mrr = document.querySelector(".main-rr");
            this.mtu = document.querySelector(".main-tu");
            this.spa = document.querySelector(".spa");
            this.load();
            this.jus2();
            this.scale();
            this.ic = $.cookie("ic");
        }
        jus2() {
            //å¯¹äºæ˜¯å¦ç»§ç»­è¿›è¡Œè´­ç‰©çš„åˆ¤æ–­ï¼Œ
            //tan1 ç»§ç»­è´­ç‰©
            //tan2 å»è´­ç‰©è½¦ç»“ç®—
            $(".tan1").on("click", function () {
                $(".tan").css({
                    display: "none",
                })
            })
            $(".tan2").on("click", function () {
                $(".tan").css({
                    display: "none",
                })
                window.location.href = "./car.html";
            })
        }
        load() {
            var that = this;
            ajax({
                url: this.url,
                success: (res) => {
                    that.res = JSON.parse(res);
                    that.display1();
                    that.display2();
                    that.display3();
                    this.display4();
                }
            })

            // this.addEvent();
        }
        display1() {
            this.mlt.innerHTML = `<img src="${this.res[this.ic].img[0]}" alt="" >
                <span class="spa"></span>
            `;
        }
        display2() {
            var str1 = "";
            for (var i = 0; i < this.res[this.ic].img.length; i++) {
                str1 += `
                    <li class="dotli">
                        <img src="${this.res[this.ic].img[i]}" alt="">
                    </li>
                `
            }
            this.dots.innerHTML = str1;
            // this.addEvent();
        }
        display3() {
            var str2 = "";
            this.mrr.innerHTML = `
                        <p class="main-name">
                            <span>ä¹èè‡ªè¥</span>
                            ${this.res[this.ic].id}</p>
                        <p class="main-tip">${this.res[this.ic].tip}</p>
                        <p class="main-address">é…é€è¯´æ˜ï¼š<span>ç°è´§</span> 24:00å‰å®Œæˆæ”¯ä»˜ï¼Œé¢„è®¡ï¼ˆ2019.11.18ï¼‰ä¹‹å‰å‘è´§</p>
                        <p class="main-price">
                            ä»·æ ¼ï¼š<span>ï¿¥${this.res[this.ic].money}</span></p>
                        <div class="addcart" index="${this.res[this.ic].id}" price="${this.res[this.ic].money}"><span>åŠ å…¥è´­ç‰©è½¦</span></div>
                        <div class="scal" ><img src="${this.res[this.ic].img[0]}" alt="" class="scalimg"></div>
            `
            this.addEvent();

        }
        display4() {
            var str3 = "";
            for (var i = 0; i < this.res[this.ic].bgimg.length; i++) {
                str3 += `
                <p class="imgg"><img data-src="${this.res[this.ic].bgimg[i]}" alt=""></p>
                `
            }
            this.mtu.innerHTML = str3;
            this.lazyload();
        }
        //æ‡’åŠ è½½çš„éƒ¨åˆ†
        lazyload(){
            var imgs = document.querySelectorAll(".imgg img");
            // console.log(imgs.length);
            var clientH = document.documentElement.clientHeight;
            // console.log(clientH);
            var scrollT = document.documentElement.scrollTop;
            // var scrollT;
            var arr = Array.from(imgs);
            // var arr = [];
            // for(var i=0;i<imgs.length;i++){
            //     arr.push(imgs[i]);
            // }
            function ld(elements,cH,sT){
                for(var i=0;i<arr.length;i++){
                    if(arr[i].offsetTop < cH + sT){
                        arr[i].src = arr[i].getAttribute("data-src");
                        arr.splice(i,1);
                        i--;
                    }
                }
            }
            ld(imgs,clientH,scrollT);
            onscroll = function () {
                var scrollT = document.documentElement.scrollTop;
                ld(imgs,clientH,scrollT);
            } 
        }
        scale() {
            var that = this;

            $(".main-lt").on("mouseenter", function () {
                $(".spa").css({
                    display: "block",
                })
                $(".scal").css({
                    display: "block",
                })
            })
            $(".main-lt").on("mouseleave", function () {
                $(".spa").css({
                    display: "none",
                })
                $(".scal").css({
                    display: "none",
                })
            })
            // $(".main-lt").hover(function () {

            // }, function () {

            // })
            this.mlt.onmousemove = function (eve) {
                var e = eve || window.event;
                that.move(e);
            };

        }
        move(e) {
            // var e = e || event;
            //è·å–å°ç›’å­å¯ç§»åŠ¨çš„è·ç¦»
            var x = e.clientX - $(".main-lt").offset().left - 112;
            var y = e.clientY - $(".main-lt").offset().top - 112;
            if (x < 0) {
                x = 0;
            }
            if (y < 0) {
                y = 0;
            }
            if (x > 224) {
                x = 224
            }
            if (y > 224) {
                y = 224
            }
            //å°ç›’å­çš„ä½ç½®
            $(".spa").css({ "left": x + "px", "top": y + "px" })
            //éšè—çš„å¤§ç›’å­çš„æ˜¾ç¤ºä½ç½®
            $(".scalimg").css({ "left": -x * 2 + "px", "top": -y * 2 + "px" })
        }
        addEvent(eve) {
            var e = eve || window.event;
            e.preventDefault();
            var that = this;
            $(".addcart")[0].onclick = function (e) {
                that.id = that.ic;  //æ’åºé¡µé¢å­˜çš„xx.attr("index")çš„å€¼
                that.goodsid = $(".addcart").attr("index");   //åŒä¸Šï¼Œå•†å“å¯¹åº”çš„å•†å“å
                that.price = $(".addcart").attr("price");     //å•†å“çš„ä»·æ ¼
                $(".tan").css({
                    display: "block",
                })
                that.setCookie();
            }
            $(".dotli").on("click", function () {
                console.log($(this).index());
                var t = $(this).index();
                $(this).css({
                    border: "1px solid #F01E00"
                }).siblings().css({
                    border: "1px solid #f0f0f0",
                })
                that.mlt.innerHTML = `<img src="${that.res[that.ic].img[t]}" alt="">`;
                $(".scal").html(`<img src="${that.res[that.ic].img[t]}" alt="" class="scalimg">`);
                that.scale();
            })
            $(".rr").on("click", function () {
                var dotsli = document.querySelectorAll(".dots li");
                $(".dots").append(dotsli[0]);
            })
            $(".ll").on("click", function () {
                var dotsli = document.querySelectorAll(".dots li");
                $(".dots").prepend(dotsli[dotsli.length - 1]);
                return false;
            })


        }
        setCookie() {
            //è®¾ç½®goodsï¼Œæ·»åŠ è¿‡å°±è·å–goodsï¼Œæ²¡æœ‰å°±è®¾ç½®ä¸ºä¸€ä¸ªç©º[]
            this.goods = localStorage.getItem("goods") ? JSON.parse(localStorage.getItem("goods")) : [];
            if (this.goods.length === 0) {  //å¦‚æœè¿˜æ²¡æœ‰æ·»åŠ è¿‡çš„è¯ï¼Œæ·»åŠ å¦‚ä¸‹ä¿¡æ¯
                this.goods.push({
                    id: this.id,    //åœ¨all.jsonä¸­çš„ä¸‹æ ‡
                    num: 1, //æ•°é‡ä¸º1
                    goodsid: this.goodsid,  // å•†å“å
                    price: this.price   //å•†å“ä»·æ ¼
                })
            } else {
                var onoff = true;
                for (var i = 0; i < this.goods.length; i++) {
                    if (this.goods[i].id === this.id) { //å¦‚æœä»è¯¦æƒ…é¡µæ·»åŠ çš„å•†å“åœ¨goodsä¸­å·²ç»å­˜åœ¨
                        this.goods[i].num++;    //å°†å•†å“çš„æ•°é‡åŠ ä¸€
                        onoff = false;  //onoff è½¬ä¸ºfalse
                    }
                }
                if (onoff) {    //å¦‚æœä¹‹å‰æ²¡æœ‰æ·»åŠ è¿‡ï¼Œæ·»åŠ å¦‚ä¸‹
                    this.goods.push({
                        id: this.id,
                        num: 1,
                        goodsid: this.goodsid,
                        price: this.price
                    })
                }
            }
            localStorage.setItem("goods", JSON.stringify(this.goods));
        }
    }

    new Details()
</script>

</html>